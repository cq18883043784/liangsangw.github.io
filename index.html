<!DOCTYPE html>
<html>
<head>
    <title>Ë¥¢Á®éÊô∫ËÉΩÂä©ÊâãPro Â∞ä‰∫´Áâà</title>
    <style>
        :root {
            --primary: #1890ff;
            --secondary: #f8faff;
            --text: #2c3e50;
            --ai-avatar: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAAAXVBMVEUAAAAkJCQpKSkuLi4rKyswMDAvLy8sLCwrKysqKionJycjIyMoKCglJSUmJiYjIyMlJSUmJiYjIyMkJCQlJSUkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQaJxKQAAAAHnRSTlMA6xQkHhH+0UQZBPXy7+rm4NvX0M3HwL61q6Shm5eDdGkq8Z4AAAIkSURBVHja7NrpUtswFEDh2A6xY0hYQ8LeQqCl7PvS/v+3VbSlXUYt8EaM5pz3R8Y+0mh0rRgAAAAAAAAAAAAAACDRnDk6Xv7a7rZvx9w8n0zG4/F4Mjk9mU5Hl1f7l5ub6y0Xr9rHp8dHh4eHh0fHx8dHh7vNq1V7t3l1vXl/8+rmZvN+8/7N5tWqvdv8+O3Xx3ebV6v2bvO7n59/3m1erdq7zZ9+ffv6bvNq1d5t/vLr59d3m1er9m7z159f321erdq7zT9+fn23ebVq7zb/8fn13ebVqr3b/Pvn13ebV6v2bvP/P7++27xatXeb//38+m7zatXebf7v8+u7zatVe7f5/8+v7zavVu3d5l8/v77bvFq1d5t//vz6bvNq1d5t/vXz67vNq1V7t/nXz6/vNq9W7d3mXz+/vtu8WrV3m3/7/Ppu82rV3m3+5/Pr+82rVXu3+Z/Pr+83r1bt3eY/P7++37xatXeb//78+n7zatXebf7v8+u7zatVe7f5/8+v7zavVu3d5l8/v77bvFq1d5t//vz6bvNq1d5t/nwH6X1Jt5QfD3IAAAAASUVORK5CYII=');
            --user-avatar: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAAAXVBMVEUAAAD///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9BujROAAAAHnRSTlMA6xQkHhH+0UQZBPXy7+rm4NvX0M3HwL61q6Shm5eDdGkq8Z4AAAIkSURBVHja7NrpUtswFEDh2A6xY0hYQ8LeQqCl7PvS/v+3VbSlXUYt8EaM5pz3R8Y+0mh0rRgAAAAAAAAAAAAAACDRnDk6Xv7a7rZvx9w8n0zG4/F4Mjk9mU5Hl1f7l5ub6y0Xr9rHp8dHh4eHh0fHx8dHh7vNq1V7t3l1vXl/8+rmZvN+8/7N5tWqvdv8+O3Xx3ebV6v2bvO7n59/3m1erdq7zZ9+ffv6bvNq1d5t/vLr59d3m1er9m7z159f321erdq7zT9+fn23ebVq7zb/8fn13ebVqr3b/Pvn13ebV6v2bvP/P7++27xatXeb//38+m7zatXebf7v8+u7zatVe7f5/8+v7zavVu3d5l8/v77bvFq1d5t//vz6bvNq1d5t/vXz67vNq1V7t/nXz6/vNq9W7d3mXz+/vtu8WrV3m3/7/Ppu82rV3m3+5/Pr+82rVXu3+Z/Pr+83r1bt3eY/P7++37xatXeb//78+n7zatXebf7v8+u7zatVe7f5/8+v7zavVu3d5l8/v77bvFq1d5t//vz6bvNq1d5t/nwH6X1Jt5QfD3IAAAAASUVORK5CYII=');
        }

        /* Êñ∞ÁâàÂ§¥ÂÉèÁ≥ªÁªü */
        .avatar-box {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
        }
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-size: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .user-avatar { background-image: var(--user-avatar); }
        .ai-avatar { background-image: var(--ai-avatar); }

        /* Ê∂àÊÅØÊ∞îÊ≥°Á≥ªÁªü */
        .message {
            margin: 20px 0;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .user-message { flex-direction: row-reverse; }
        .bubble {
            max-width: 75%;
            padding: 20px;
            border-radius: 24px;
            line-height: 1.7;
            font-size: 15px;
            position: relative;
            transition: transform 0.2s;
        }
        .user-bubble {
            background: linear-gradient(135deg, var(--primary) 0%, #096dd9 100%);
            color: white;
            border-radius: 24px 4px 24px 24px;
            box-shadow: 0 4px 12px rgba(24,144,255,0.2);
        }
        .ai-bubble {
            background: linear-gradient(45deg, #ffffff 0%, #f8f9ff 100%);
            border: 1px solid #e8f4ff;
            border-radius: 4px 24px 24px 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        /* Êó∂Èó¥Ê†áÁ≠æ */
        .time {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 8px;
            display: block;
            text-align: right;
            opacity: 0.7;
        }

        /* ÂÖ®Â±ÄÊ†∑Âºè‰ºòÂåñ */
        body {
            font-family: 'Segoe UI', system-ui;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e9ff 100%);
            margin: 0;
            padding: 24px;
            min-height: 100vh;
        }
        .chat-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.98);
            border-radius: 24px;
            box-shadow: 0 16px 32px rgba(0,0,0,0.12);
            backdrop-filter: blur(12px);
        }
        #chatHistory {
            height: 68vh;
            padding: 24px;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq2awtARDRH4wCVKlCgBKm8S3A0AHT0JCY0rD5cAAAAASUVORK5CYII=');
            overflow-y: auto;
        }
        .toolbar {
            padding: 16px 24px;
            border-bottom: 1px solid rgba(232,232,232,0.5);
            display: flex;
            gap: 16px;
            background: var(--secondary);
            border-radius: 24px 24px 0 0;
        }
        #inputArea {
            display: flex;
            gap: 16px;
            padding: 24px;
            background: var(--secondary);
            border-radius: 0 0 24px 24px;
        }
        #userInput {
            flex: 1;
            padding: 16px 24px;
            border: 2px solid #e8f4ff;
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }
        button {
            background: linear-gradient(135deg, var(--primary) 0%, #096dd9 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(24,144,255,0.3);
        }

        /* Ë°®Ê†º‰ºòÂåñ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 14px 18px;
            border-bottom: 1px solid #e8f4ff;
        }
        th {
            background: var(--secondary);
            color: var(--primary);
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #f8faff;
        }
        tr:hover {
            background: #e3f2ff;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading {
            display: none;
            padding: 24px;
            text-align: center;
            color: #666;
            background: rgba(255,255,255,0.95);
        }
        .loader {
            width: 28px;
            height: 28px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="toolbar">
            <button onclick="clearHistory()">üóëÔ∏è Ê∏ÖÁ©∫ÂØπËØù</button>
            <button onclick="exportHistory()">üì§ ÂØºÂá∫ËÆ∞ÂΩï</button>
        </div>
        <div id="chatHistory"></div>
        <div class="loading">
            <div class="loader"></div>
            <span>AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...</span>
        </div>
        <div id="inputArea">
            <input type="text" id="userInput" placeholder="ËæìÂÖ•Ë¥¢Á®éÈóÆÈ¢òÔºå‰æãÂ¶ÇÔºöÂ¢ûÂÄºÁ®éÁî≥Êä•Ê≥®ÊÑè‰∫ãÈ°π..." autocomplete="off">
            <button onclick="sendToAI()">üöÄ ÂèëÈÄÅ</button>
        </div>
    </div>

<script>
const config = {
    apiKey: "pat_9BGmDeD9muJT0GK6MgekNE4AZ2cUdjaO0BggA3AEfW5B3NiNWUSXS35SE61D3LB0",
    botId: "7477879044256841743",
    apiEndpoint: "https://api.coze.cn/open_api/v2/chat"
};

// Ë°®Ê†ºËΩ¨Êç¢ÂáΩÊï∞
function formatTables(content) {
    const tableRegex = /(\|.*\|(?:\n\|.*\|)+)/g;
    return content.replace(tableRegex, (match) => {
        const rows = match.trim().split('\n');
        let html = '<table>';
        rows.forEach((row, index) => {
            const cells = row.split('|').slice(1, -1).map(cell => 
                index === 0 ? `<th>${cell.trim()}</th>` : `<td>${cell.trim()}</td>`
            ).join('');
            html += `<tr>${cells}</tr>`;
        });
        return html + '</table>';
    });
}

// Ê∂àÊÅØÂ§ÑÁêÜÂáΩÊï∞ÔºàÂ∑≤‰øÆÂ§çÈáçÂ§çÂ§¥ÂÉèÈóÆÈ¢òÔºâ
function appendMessage(content, type) {
    const chatHistory = document.getElementById('chatHistory');
    const timestamp = new Date().toLocaleTimeString('zh-CN', { 
        hour: '2-digit', 
        minute: '2-digit'
    });

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const formattedContent = formatTables(content.replace(/(Êõ¥Â§öÂÖçË¥πËµÑÊñô|ÂÖ≥Ê≥®ÂÖ¨‰ºóÂè∑).*$/g, ''));

    messageDiv.innerHTML = `
        <div class="${type === 'user' ? 'user-avatar' : 'ai-avatar'} avatar"></div>
        <div class="bubble ${type}-bubble">
            <div class="avatar-box">
                <span class="username">${type === 'user' ? 'Êàë' : 'Âæ∑ÈùôÈÉëÊÄª'}</span>
            </div>
            <div>${formattedContent}</div>
            <span class="time">${timestamp}</span>
        </div>
    `;

    chatHistory.appendChild(messageDiv);
    scrollToBottom();
    saveHistory();
}

// ÂÖ∂‰ªñÂäüËÉΩ‰øùÊåÅ‰∏çÂèò
window.onload = () => {
    const history = localStorage.getItem('chatHistory');
    if(history) {
        document.getElementById('chatHistory').innerHTML = history;
        scrollToBottom();
    }
};

async function sendToAI() {
    const userInput = document.getElementById('userInput');
    const chatHistory = document.getElementById('chatHistory');
    const loading = document.querySelector('.loading');
    const question = userInput.value.trim();

    if (!question) return;

    try {
        appendMessage(question, 'user');
        userInput.value = '';
        loading.style.display = 'flex';

        const response = await fetch(config.apiEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${config.apiKey}`
            },
            body: JSON.stringify({
                bot_id: config.botId,
                user: `user_${Date.now()}`,
                query: question,
                stream: false
            })
        });

        if (!response.ok) throw new Error(`ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
        
        const data = await response.json();
        if (data.code !== 0) throw new Error(data.msg || "ÊúçÂä°ÂºÇÂ∏∏");

        const validMessage = data.messages.find(msg => 
            msg.type === 'answer' && !msg.content.includes('knowledge_recall')
        );
        
        if(validMessage) {
            appendMessage(validMessage.content, 'ai');
        } else {
            throw new Error("Êú™Ëé∑ÂèñÂà∞ÊúâÊïàÂõûÂ§ç");
        }

    } catch (error) {
        appendMessage(`‚ö†Ô∏è Á≥ªÁªüÈîôËØØÔºö${error.message}`, 'error');
    } finally {
        loading.style.display = 'none';
        saveHistory();
    }
}

function scrollToBottom() {
    const chatHistory = document.getElementById('chatHistory');
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function saveHistory() {
    localStorage.setItem('chatHistory', document.getElementById('chatHistory').innerHTML);
}

function clearHistory() {
    if(confirm('Á°ÆËÆ§Ê∏ÖÁ©∫ÂØπËØùÂéÜÂè≤ÂêóÔºü')) {
        document.getElementById('chatHistory').innerHTML = '';
        localStorage.removeItem('chatHistory');
    }
}

function exportHistory() {
    const content = document.getElementById('chatHistory').innerText;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Ë¥¢Á®éÂä©ÊâãËÆ∞ÂΩï_${new Date().toLocaleDateString()}.txt`;
    a.click();
}

document.getElementById('userInput').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') sendToAI();
});
</script>
</body>
</html>